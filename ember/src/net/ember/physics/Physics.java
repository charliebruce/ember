package net.ember.physics;

import java.nio.ByteBuffer;
import java.nio.FloatBuffer;
import java.nio.IntBuffer;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

import javax.vecmath.Quat4f;
import javax.vecmath.Vector3f;

import net.ember.client.Client;
import net.ember.data.PhysicsMesh;
import net.ember.game.Entity;
import net.ember.logging.Log;
import net.ember.logging.Timer;

import com.bulletphysics.collision.broadphase.AxisSweep3;
import com.bulletphysics.collision.dispatch.CollisionConfiguration;
import com.bulletphysics.collision.dispatch.CollisionDispatcher;
import com.bulletphysics.collision.dispatch.CollisionObject;
import com.bulletphysics.collision.dispatch.DefaultCollisionConfiguration;
import com.bulletphysics.collision.shapes.BoxShape;
import com.bulletphysics.collision.shapes.BvhTriangleMeshShape;
import com.bulletphysics.collision.shapes.CollisionShape;
import com.bulletphysics.collision.shapes.TriangleIndexVertexArray;
import com.bulletphysics.dynamics.DiscreteDynamicsWorld;
import com.bulletphysics.dynamics.RigidBody;
import com.bulletphysics.dynamics.RigidBodyConstructionInfo;
import com.bulletphysics.dynamics.constraintsolver.SequentialImpulseConstraintSolver;
import com.bulletphysics.linearmath.DefaultMotionState;
import com.bulletphysics.linearmath.Transform;
import com.bulletphysics.util.ObjectArrayList;

/**
 * Process dynamics, motion and collision/interaction in here.
 * Units are always meters, kilograms and seconds.
 * 
 * HOw are we going to handle material footsteps, fighting and loading? callbacks or a second, lowfi collision detection?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       f 
 * @author Charlie
 * 
 * Player is a capsule, rest is mesh or rigidbody or AIBody? Think this through? Ghost objects. AI-AI collision not poss. Player only. for simplicity.
 * Use Bullet KinematicCharacter combined with research of JMonkey
 *
 */
public class Physics {

	static ObjectArrayList<CollisionShape> collisionShapes;
	static DiscreteDynamicsWorld dynamicsWorld;
	
	static List<Entity> physEntities;
	static AxisSweep3 overlappingPairCache;
	/**
	 * Step dt into the future, and read the state back out of the physics system.
	 */
	public static void tick() {
				
		
		/**
		 * First, update the state of character controllers etc. These have been updated by the input system
		 * and now need processing.
		 */
		for(CharacterController cc: ccs){
			cc.tick();
		}
		
		
		
		/**
		 * Step the simulation
		 */
	 
		boolean slowmo = false;
		
		if(slowmo)
			 dynamicsWorld.stepSimulation(Client.FRAME_TIME*0.1f, 0,1f/60f);
		 else
			 dynamicsWorld.stepSimulation(Client.FRAME_TIME, 1);


		/**
		 *  Read back into variables used by sound and render system.
		 */
		for (int j=dynamicsWorld.getNumCollisionObjects()-1; j>=0; j--)
		{
			CollisionObject obj = dynamicsWorld.getCollisionObjectArray().getQuick(j);
			RigidBody body = RigidBody.upcast(obj);
			if (body != null && body.getMotionState() != null) {
				Transform trans = new Transform();
				body.getMotionState().getWorldTransform(trans);
				//or use e.motionstate directly?
				//System.out.printf("%f,%f,%f\n", trans.origin.x,
				//		trans.origin.y, trans.origin.z);

			}
		}
		
		Transform t = new Transform();
		//Vector3f v = new Vector3f();
		//Quat4f q = new Quat4f();
		
		for(Entity e: physEntities){
			//e.rigidBody.activate();
			//e.rigidBody.applyCentralImpulse(new Vector3f(0.00f,-0.10f,0.0f));
			
			e.rigidBody.getLinearVelocity(e.velocity);//Any need for this are the vectors pointers or clones?
			e.rigidBody.getWorldTransform(t);
			e.position.set(t.origin);
			e.rigidBody.getOrientation(e.orientation);
			//e.orientation.set(arg0)
			//Log.info("Velocity: "+e.velocity.toString()+", Position: "+e.position.toString()+", Orientation: "+e.orientation.toString());
			/*e.rigidBody.getWorldTransform(t);
			//Log.info("Origin "+t.origin.toString());
			e.rigidBody.getOrientation(q);
			
			e.position[0]=t.origin.x;
			e.position[1]=t.origin.y;
			e.position[2]=t.origin.z;
			e.velocity[0]=v.x;
			e.velocity[1]=v.y;
			e.velocity[2]=v.z;
			e.orientation[0]=q.w;
			e.orientation[1]=q.x;
			e.orientation[2]=q.y;
			e.orientation[3]=q.z;|*/
			
			//Log.info("Object "+e.getName()+" is at "+e.position.toString());
		}
		
		
		
		for(CharacterController cc: ccs){
			//Transform out = new Transform();
			//cc.ghostObject.getWorldTransform(out);
			//Log.info("Ghost: "+out.origin.toString());
			cc.move();
		}
		

	}

	public static void init() {
		
		physEntities = new LinkedList<Entity>();
		
		// collision configuration contains default setup for memory, collision
		// setup. Advanced users can create their own configuration.
		CollisionConfiguration collisionConfiguration = new DefaultCollisionConfiguration();

		// use the default collision dispatcher. For parallel processing you
		// can use a different dispatcher (see Extras/BulletMultiThreaded)
		CollisionDispatcher dispatcher = new CollisionDispatcher(collisionConfiguration);

		// the maximum size of the collision world. Make sure objects stay
		// within these boundaries
		// Don't make the world AABB size too large, it will harm simulation
		// quality and performance
		Vector3f worldAabbMin = new Vector3f(-10000, -10000, -10000);
		Vector3f worldAabbMax = new Vector3f(10000, 10000, 10000);
		int maxProxies = 1024;
		overlappingPairCache = new AxisSweep3(worldAabbMin, worldAabbMax, maxProxies);
		//BroadphaseInterface overlappingPairCache = new SimpleBroadphase(maxProxies);

		// the default constraint solver. For parallel processing you can use a
		// different solver (see Extras/BulletMultiThreaded)
		SequentialImpulseConstraintSolver solver = new SequentialImpulseConstraintSolver();

		dynamicsWorld = new DiscreteDynamicsWorld(
				dispatcher, overlappingPairCache, solver,
				collisionConfiguration);

		//The world uses meters, vertical gravity.
		dynamicsWorld.setGravity(new Vector3f(0f, -9.81f, 0f));

		// create a few basic rigid bodies
		CollisionShape groundShape = new BoxShape(new Vector3f(20000.f, -5000.f, 20000.f));

		// keep track of the shapes, we release memory at exit.
		// make sure to re-use collision shapes among rigid bodies whenever
		// possible!
		collisionShapes = new ObjectArrayList<CollisionShape>();

		collisionShapes.add(groundShape);

		
		
		
		
		Transform groundTransform = new Transform();
		groundTransform.setIdentity();
		//groundTransform.origin.set(new Vector3f(0.f, -1000.f, 0.f)); // For testing collision meshes.
		groundTransform.origin.set(new Vector3f(0.f, 0.f, 0.f));

		float mass = 0f;

		// rigidbody is dynamic if and only if mass is non zero,
		// otherwise static
		
		Vector3f localInertia = new Vector3f(0, 0, 0);
		

		// using motionstate is recommended, it provides interpolation
		// capabilities, and only synchronizes 'active' objects
		DefaultMotionState myMotionState = new DefaultMotionState(groundTransform);
		RigidBodyConstructionInfo rbInfo = new RigidBodyConstructionInfo(
				mass, myMotionState, groundShape, localInertia);
		RigidBody body = new RigidBody(rbInfo);

		body.setFriction(0.5f);
		body.setRestitution(0.1f);
		body.setDamping(0.1f, 0.1f);
		// add the body to the dynamics world
		//dynamicsWorld.addRigidBody(body);


		/*
		 * Testing only TODO incorp into regions.
		 */
		
		//addStaticMesh(new PhysicsMesh(), new Vector3f(0.0f,0.0f,0.0f),new Quat4f(0.0f,0.0f,0.0f,1.0f));


		//dynamicsWorld.setInternalTickCallback(cb, worldUserInfo)
		//dispatcher.setNearCallback(nearCallback)


	}

	public static void addEntity(Entity e){
		
		if(!e.isPhysical||e.collisionShape==null) {
			Log.info("Tried to add a "+e.getName() + " but it is not physical. The call has no effect.");
			return;
		}
		physEntities.add(e);
		
		CollisionShape c = e.collisionShape;
		RigidBody body;

		
		
		//if (e instanceof Terrain){
			
		//}

		collisionShapes.add(c);
		
		Transform t = new Transform();
		t.setIdentity();
		t.origin.set(e.position);

		Vector3f localInertia = new Vector3f(0, 0, 0);
		if (e.mass!=0f) {
			c.calculateLocalInertia(e.mass, localInertia);
		}

		// using motionstate is recommended, it provides interpolation
		// capabilities, and only synchronizes 'active' objects
		DefaultMotionState myMotionState = new DefaultMotionState(t);
		RigidBodyConstructionInfo rbInfo = new RigidBodyConstructionInfo(
				e.mass, myMotionState, c, localInertia);
		body = new RigidBody(rbInfo);


		body.setFriction(0.5f);
		body.setRestitution(0.4f);

		e.rigidBody = body;
		
		// add the body to the dynamics world
		dynamicsWorld.addRigidBody(body);


		Log.info("New physical entity added is "+ e.getName());
		return;
	}


	public static void removeEntity(Entity e){
		dynamicsWorld.removeRigidBody(e.rigidBody);
		e.rigidBody.destroy();
	}
	
	
	
	
	
	public static void addMesh(int faces, int verts, java.nio.ByteBuffer vertices, java.nio.ByteBuffer indices){
		
		int vertStride = 3 * 4;
		int indexStride = 3 * 4;

		float[] mydata = new float[]{0.0f,0.0f,0.0f,1000.0f,0.0f,0.0f,0.0f,0.0f,1000.0f,0.0f,0.0f,0.0f,0.0f,0.0f,1000.0f,1000.0f,0.0f,1000.0f};
		int[] myindices = new int[]{0,1,2,3,4,5};
		ByteBuffer vertbuffer = ByteBuffer.allocate(4*mydata.length);
		ByteBuffer indbuffer = ByteBuffer.allocate(4*myindices.length);
		for(int i=0;i<mydata.length;i++){
			vertbuffer.putFloat(mydata[i]);
		}
		for(int i=0;i<myindices.length;i++){
			indbuffer.putInt(myindices[i]);
		}
		TriangleIndexVertexArray indexVertexArrays = new TriangleIndexVertexArray(
				2,indbuffer,indexStride,
				6, vertbuffer, vertStride);

		boolean useQuantizedAabbCompression = true;

		BvhTriangleMeshShape trimeshShape = new BvhTriangleMeshShape(indexVertexArrays, useQuantizedAabbCompression);
		collisionShapes.add(trimeshShape);
		

		Transform t = new Transform();
		t.setIdentity();
		t.origin.set(new Vector3f(0.0f,0.0f,0.0f));

		
		
		DefaultMotionState myMotionState = new DefaultMotionState(t);
		RigidBodyConstructionInfo rbInfo = new RigidBodyConstructionInfo(
				0.0f, myMotionState, trimeshShape, new Vector3f(0.0f,0.0f,0.0f));
		RigidBody body = new RigidBody(rbInfo);

		body.setRestitution(0.4f);
		dynamicsWorld.addRigidBody(body);
		
	}
	
	/**
	 * Load the given mesh into the physics engine.
	 * TODO optimised BVH
	 * TODO optimise speed in general.
	 * @param m
	 * @param position
	 * @param orientation
	 */
	public static RigidBody addStaticMesh(PhysicsMesh m, Vector3f position, Quat4f orientation ){
		Log.info("Loading a static physics mesh.");
		
		if(!m.loaded)
			Log.err("The physics mesh data has not been loaded but the mesh was loaded into the physics system!");
		
		int vertStride = 3 * 4;
		int indexStride = 3 * 4;


		TriangleIndexVertexArray indexVertexArrays = new TriangleIndexVertexArray(
				m.faces, m.indexBuffer, indexStride,
				m.points, m.dataBuffer, vertStride);

		FloatBuffer f = m.dataBuffer.asFloatBuffer();
		float min = 0.0f;
		float max = 0.0f;
		for(int i=0;i<f.limit();i++){
			float fa = f.get();
			min = Math.min(min, fa);
			max = Math.max(max, fa);
		}
		f.rewind();
		
		Log.info("Max is "+max+" min is "+min);
		boolean useQuantizedAabbCompression = true;

		BvhTriangleMeshShape trimeshShape = new BvhTriangleMeshShape(indexVertexArrays, useQuantizedAabbCompression);
		collisionShapes.add(trimeshShape);
		
		
		Transform t = new Transform();
		t.setIdentity();
		t.origin.set(position);
		t.setRotation(orientation);
		
		
		DefaultMotionState myMotionState = new DefaultMotionState(t);
		
		RigidBodyConstructionInfo rbInfo = new RigidBodyConstructionInfo(
				0.0f, myMotionState, trimeshShape, new Vector3f(0.0f,0.0f,0.0f));
		RigidBody body = new RigidBody(rbInfo);

		body.setRestitution(0.4f);
		
		//TODO add to collisionShapes?
		dynamicsWorld.addRigidBody(body);
		Log.info("finished loading the static mesh.");
		return body;
	}

	/**
	 * Remove the given body from the dynamics world immediately.
	 * Used when regions unload their meshes.
	 */
	public static void removeBody(RigidBody body) {
		dynamicsWorld.removeRigidBody(body);
	}
	
	private static List<CharacterController> ccs = new ArrayList<CharacterController>();

	public static void addCC(CharacterController characterController) {
		ccs.add(characterController);
	}
	
}
	
	
	
	
